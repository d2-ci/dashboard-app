(this["webpackJsonp@dhis2/app-shell"]=this["webpackJsonp@dhis2/app-shell"]||[]).push([[140],{1985:function(e,a,t){"use strict";t.r(a);var s=t(0),l=t.n(s),n=t(11),r=t(4),i=t.n(r),o=t(9),u=t(8),c=t(246),d=t(5),p=t.n(d);function b(){return(b=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e}).apply(this,arguments)}const f={resource:"legendSets",params:({ids:e})=>({fields:"id,displayName~rename(name),legends[id,displayName~rename(name),startValue,endValue,color]",filter:"id:in:[".concat(e.join(","),"]")})},h=({style:e={width:18,height:18}})=>l.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:e},l.a.createElement("path",{d:"M0 0h24v24H0V0z",fill:"none"}),l.a.createElement("path",{d:"M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z",fill:"black"}));h.propTypes={style:i.a.object};const v=({style:e={width:18,height:18}})=>l.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:e},l.a.createElement("path",{d:"M0 0h24v24H0V0z",fill:"none"}),l.a.createElement("path",{d:"M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z",fill:"black"}));v.propTypes={style:i.a.object};const g=({config:e,ouLevels:a,onClick:t})=>{const n=Object(o.e)(),[r,i]=Object(s.useState)(void 0),[d,b]=Object(s.useState)(void 0),f=Object(s.useCallback)((async e=>await Object(c.r)(n,e)),[n]);Object(s.useEffect)((()=>{i(null);e.ouId&&(async()=>{const a=await f(e.ouId);i(a)})()}),[e]),Object(s.useEffect)((()=>{if(b(null),null!==r&&void 0!==r&&r.children.length){const t=(e=r.children[0].level,a.find((a=>a.level===e)));t&&b(t)}var e}),[r]);const g={display:"inline-block",minWidth:200};return l.a.createElement(u.l,null,r&&l.a.createElement(u.E,{dense:!0,label:p.a.t("Change org unit")},(null===r||void 0===r?void 0:r.parent)&&l.a.createElement(l.a.Fragment,null,l.a.createElement(u.E,{dense:!0,icon:l.a.createElement(h,null),label:l.a.createElement("span",{style:g},r.parent.name),onClick:()=>t({ou:{id:r.parent.id}})}),d&&l.a.createElement(u.k,null)),d&&l.a.createElement(u.E,{dense:!0,icon:l.a.createElement(v,null),label:l.a.createElement("span",{style:g},p.a.t("{{level}} level in {{orgunit}}",{level:d.name,orgunit:r.name})),onClick:()=>t({ou:{id:r.id,path:r.path,level:d.id}})})))};g.propTypes={config:i.a.object,ouLevels:i.a.array,onClick:i.a.func};const m=({visualization:e,responses:a,extraOptions:t,legendSets:n,id:r,style:i,onChartGenerated:o,animation:u})=>{const d=Object(s.useRef)(void 0),p=Object(s.useCallback)((s=>{const l=Object(c.t)(a,e,d.current,{...t,animation:s,legendSets:n},void 0,void 0,Object(c.x)(e.type)?"dhis":"highcharts");Object(c.x)(e.type)?o(l.visualization):o(l.visualization.getSVGForExport({sourceHeight:768,sourceWidth:1024}))}),[d,e,o,a,t,n]);return Object(s.useEffect)((()=>{p(u)}),[e,a,t]),Object(s.useEffect)((()=>{null!==r&&p(0)}),[r,i]),l.a.createElement("div",{ref:d,style:i})};m.defaultProps={visualization:{},filters:{},style:{},animation:200,onChartGenerated:Function.prototype},m.propTypes={extraOptions:i.a.object.isRequired,legendSets:i.a.arrayOf(i.a.object).isRequired,responses:i.a.arrayOf(i.a.object).isRequired,visualization:i.a.object.isRequired,animation:i.a.number,id:i.a.number,style:i.a.object,onChartGenerated:i.a.func};const y=({responses:e,legendSets:a,visualization:t,style:s,id:n,onToggleContextualMenu:r})=>l.a.createElement("div",{style:s},l.a.createElement(c.j,{visualization:t,data:e[0].response,legendSets:a,renderCounter:n,onToggleContextualMenu:r}));y.defaultProps={style:{}},y.propTypes={legendSets:i.a.arrayOf(i.a.object).isRequired,responses:i.a.arrayOf(i.a.object).isRequired,visualization:i.a.object.isRequired,id:i.a.number,style:i.a.object,onToggleContextualMenu:i.a.func};const w=e=>Object(c.w)(c.p).getPeriods().find((a=>a.id===e[0].id))?c.p:Object(c.w)(c.c).getPeriods().find((a=>a.id===e[0].id))?c.c:void 0,S=c.e,D=async(e,a,t)=>{const s=c.a.getAnalytics(e),l=(new s.request).fromVisualization(a).withParameters(t).withIncludeNumDen(a.type===c.n),n=await s.aggregate.get(l);return[new s.response(n)]},E=({yearlySeriesRes:e,currentMonth:a,currentDay:t})=>{const s=[],l=[],n=e.metaData.dimensions[S].slice().sort().reverse(),r="02"===a&&"29"===t;return n.forEach((n=>{s.push(e.metaData.items[n].name);const i=29===new Date(n,1,29).getDate();r&&!i?l.push("".concat(n,"-02-28")):l.push("".concat(n,"-").concat(a,"-").concat(t))})),{yearlySeriesLabels:s,periodDates:l}},O=async({analyticsEngine:e,visualization:a,options:t,yearlySeriesRes:s,currentMonth:l,currentDay:n})=>{const r=[],i=[],o=s.metaData.dimensions[S].slice().sort().reverse(),u=o.shift();r.push(s.metaData.items[u].name),i.push("".concat(u,"-").concat(l,"-").concat(n));const c=(new e.request).fromVisualization(a).withParameters(t).withRelativePeriodDate("".concat(u,"-").concat(l,"-").concat(n)).withSkipData(!0).withSkipMeta(!1),d=(await e.aggregate.fetch(c)).metaData.dimensions[S].pop(),[p,b]=d.split("W"),f=u-p,h=o.reduce(((e,a)=>(r.push(s.metaData.items[a].name),e.push("".concat(a-f,"W").concat(b)),"53"===b&&e.push("".concat(a-f,"W52")),e)),[]);if(h.length){const a=(new e.request).addPeriodDimension(h).withSkipData(!0).withSkipMeta(!1).withIncludeMetadataDetails(!0),t=await e.aggregate.fetch(a),s=[];t.metaData.dimensions[S].sort().reverse().forEach((e=>{const a=e.substr(0,4);if(!s.includes(a)){const l=new Date(t.metaData.items[e].endDate);l.setDate(l.getDate()+1),i.push("".concat(l.getFullYear(),"-").concat((""+(l.getMonth()+1)).padStart(2,0),"-").concat((""+l.getDate()).padStart(2,0))),s.unshift(a)}}))}return{yearlySeriesLabels:r,periodDates:i}},q={axes:{requestable:!1,savable:!0,defaultValue:[]},colorSet:{defaultValue:c.b,requestable:!1,savable:!0},cumulativeValues:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyRowItems:{defaultValue:"NONE",requestable:!1,savable:!0},legend:{defaultValue:{},requestable:!1,savable:!0},noSpaceBetweenColumns:{defaultValue:!1,requestable:!1,savable:!0},percentStackedValues:{defaultValue:!1,requestable:!1,savable:!0},regressionType:{defaultValue:"NONE",requestable:!1,savable:!0},showData:{defaultValue:!0,requestable:!1,savable:!0},aggregationType:{defaultValue:"DEFAULT",requestable:!0,savable:!0},completedOnly:{defaultValue:!1,requestable:!0,savable:!0},hideSubtitle:{defaultValue:!1,requestable:!1,savable:!0},hideTitle:{defaultValue:!1,requestable:!1,savable:!0},sortOrder:{defaultValue:"0",requestable:!1,savable:!0},subtitle:{defaultValue:void 0,requestable:!1,savable:!0},title:{defaultValue:void 0,requestable:!1,savable:!0},series:{defaultValue:[],requestable:!1,savable:!0},fontStyle:{defaultValue:{},requestable:!1,savable:!0},colTotals:{defaultValue:!1,requestable:!1,savable:!0},colSubTotals:{defaultValue:!1,requestable:!1,savable:!0},rowTotals:{defaultValue:!1,requestable:!1,savable:!0},rowSubTotals:{defaultValue:!1,requestable:!1,savable:!0},showDimensionLabels:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyColumns:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyRows:{defaultValue:!1,requestable:!1,savable:!0},skipRounding:{defaultValue:!1,requestable:!0,savable:!0},numberType:{defaultValue:"VALUE",requestable:!1,savable:!0},showHierarchy:{defaultValue:!1,requestable:!0,savable:!0},legendSet:{defaultValue:void 0,requestable:!1,savable:!0},legendDisplayStrategy:{defaultValue:"FIXED",requestable:!1,savable:!0},legendDisplayStyle:{defaultValue:"FILL",requestable:!1,savable:!0},displayDensity:{defaultValue:"NORMAL",requestable:!1,savable:!0},fontSize:{defaultValue:"NORMAL",requestable:!1,savable:!0},digitGroupSeparator:{defaultValue:"SPACE",requestable:!1,savable:!0},approvalLevel:{defaultValue:void 0,requestable:!0,savable:!1},reportingPeriod:{defaultValue:!1,requestable:!1,savable:!0},organisationUnit:{defaultValue:!1,requestable:!1,savable:!0},parentOrganisationUnit:{defaultValue:!1,requestable:!1,savable:!0},grandParentOrganisationUnit:{defaultValue:!1,requestable:!1,savable:!0},regression:{defaultValue:!1,requestable:!1,savable:!0},cumulative:{defaultValue:!1,requestable:!1,savable:!0},measureCriteria:{defaultValue:void 0,requestable:!0,savable:!0},topLimit:{defaultValue:"0",requestable:!1,savable:!0}},V=()=>Object.entries(q).filter((e=>e[1].requestable)),j=async({dataEngine:e,visualization:a,filters:t,forDashboard:s,userSettings:l})=>{const n=((e,a,t)=>{const s=V().reduce(((a,[t,s])=>(void 0!==e[t]&&e[t]!==s.defaultValue&&(a[t]=e[t]),a)),{});if(a.relativePeriodDate&&(s.relativePeriodDate=a.relativePeriodDate),null!==t&&void 0!==t&&t.displayProperty)switch(t.displayProperty){case"displayShortName":s.displayProperty="SHORTNAME";break;case"displayName":s.displayProperty="NAME"}if(a.userOrgUnit&&a.userOrgUnit.length){const e=a.userOrgUnit.map((e=>e.split("/").slice(-1)[0]));s.userOrgUnit=e.join(";")}return s})(a,t,l),r={dashboard:s};if(Object(c.y)(a.type)){const{responses:t,yearlySeriesLabels:s}=await(async(e,a,t)=>{const s=c.a.getAnalytics(e);let l=(new s.request).addPeriodDimension(a.yearlySeries).withSkipData(!0).withSkipMeta(!1).withIncludeMetadataDetails(!0);t.relativePeriodDate&&(l=l.withRelativePeriodDate(t.relativePeriodDate));const n=await s.aggregate.fetch(l),r=[],i=[],o=new Date,u=(""+o.getDate()).padStart(2,0),d=(""+(o.getMonth()+1)).padStart(2,0),p=Object(c.z)(a,S);if(w(p)===c.p){const e=await O({analyticsEngine:s,visualization:a,options:t,yearlySeriesRes:n,currentMonth:d,currentDay:u});r.push(...e.periodDates),i.push(...e.yearlySeriesLabels)}else if(w(p)===c.c){const e=E({yearlySeriesRes:n,currentMonth:d,currentDay:u});r.push(...e.periodDates),i.push(...e.yearlySeriesLabels)}else n.metaData.dimensions[S].sort().reverse().forEach((e=>{i.push(n.metaData.items[e].name),r.push("".concat(e,"-").concat(d,"-").concat(u))}));const b=r.reduce(((e,l)=>{const n=(new s.request).fromVisualization(a).withParameters(t).withRelativePeriodDate(l);return e.push(s.aggregate.get(n)),e}),[]);return Promise.all(b).then((e=>({responses:e.map((e=>new s.response(e))),yearlySeriesLabels:i})))})(e,a,n),l=Object(c.z)(a,c.e),i=w(l),o=((e,a)=>{const t=e.reduce(((e,a)=>(e.push(a.metaData.dimensions.pe),e)),[]);if(a===c.c){t.sort(((e,a)=>e[0].substr(-2)-a[0].substr(-2)));const e=t.shift().map((e=>[e]));return t.forEach((a=>{a.forEach((a=>{const t=a.match(/(\d{4})(\d{2})(\d{2})/),s=t[2],l=t[3],n=e.findIndex((e=>e[0].substr(4)==="".concat(s).concat(l)));if(-1!==n)e[n].push(a);else if("02"===s&&"29"===l){const t=e.findIndex((e=>-1!==e.findIndex((e=>/0228$/.test(e)))));-1!==t?e.splice(t+1,0,[a]):e.push([a])}else e.push([a])}))})),e}if(a===c.p){t.sort(((e,a)=>a[0].split("W")[1]-e[0].split("W")[1]));const e=t.shift().map((e=>[e]));return t.forEach((a=>{a.forEach((a=>{const[t,s]=a.split("W"),l=e.findIndex((e=>e[0].split("W")[1]===s));if(-1!==l)e[l].push(a);else if("1"===s){const t=e.findIndex((e=>-1!==e.findIndex((e=>/W2$/.test(e)))));-1!==t?e[t].push(a):e.push([a])}else{const l=e.findIndex((e=>-1!==e.findIndex((e=>e==="".concat(t,"W").concat(s-1)))));e.splice(l+1,0,[a])}}))})),e}return t.reduce(((e,a)=>(a.forEach(((a,t)=>{e[t].push(a)})),e)),Array.from({length:t[0].length},(()=>[])))})(t,i),u=o.reduce(((e,a,t)=>(a.forEach((a=>e[a]=t)),e)),{}),d=i?((e,a)=>{switch(a){case c.p:return e.map((e=>e[0].substr(4))).flat();case c.c:return e.map((e=>e[0].substr(4).replace(/(\d{2})(\d{2})/,"$2-$1"))).flat()}})(o,i):(e=>{const a=e.reduce(((e,a)=>(e.metaData?a.metaData.dimensions.pe.length>e.metaData.dimensions.pe.length&&(e=a):e=a,e)),{}).metaData;return a.dimensions.pe.reduce(((e,t)=>{const s=a.items[t].name;return e.push(s.replace(/\s+\d{4}$/,"")),e}),[])})(t);return{responses:t,extraOptions:{...r,yearlySeries:s,xAxisLabels:d,periodKeyAxisIndexMap:u}}}return{responses:await D(e,a,n),extraOptions:r}};var x={backdrop:{position:"fixed",height:"100%",width:"100%",top:0,left:0,backgroundColor:"transparent"}};const z=({visualization:e,filters:a,forDashboard:t,userSettings:r,onError:i,onLoadingComplete:d,onResponsesReceived:p,onDrill:h,...v})=>{const w=Object(o.e)(),[S,D]=Object(s.useState)(void 0),[E,O]=Object(s.useState)(null),[q,V]=Object(s.useState)(void 0),[z,k]=Object(s.useState)({}),R=()=>V(void 0),C=Object(s.useCallback)((async()=>{const s=await j({dataEngine:w,visualization:e,filters:a,forDashboard:t,userSettings:r});return s.responses.length&&p(s.responses),s}),[w,a,t,r,p,e]),P=Object(s.useCallback)((async e=>{if(!e.length)return[];return await(async(e,a)=>(await e.query({legendSets:f},{variables:{ids:a}})).legendSets.legendSets)(w,e)}),[w]);if(Object(s.useEffect)((()=>{(async()=>{const e=await Object(c.s)(w);D(e)})()}),[w]),Object(s.useEffect)((()=>{O(null);(async()=>{const{responses:s,extraOptions:l}=await C(e,a,t),n=[];switch(e.legendDisplayStrategy){case"FIXED":e.legendSet&&e.legendSet.id&&n.push(e.legendSet.id);break;case"BY_DATA_ITEM":(s[0].metaData.dimensions.dx||[]).forEach((e=>{const a=s[0].metaData.items[e].legendSet;a&&n.push(a)}));break}const r=await P(n);O({visualization:e,legendSets:r,responses:s,extraOptions:l}),d()})().catch((e=>{i(e)}))}),[e,a,t]),!E)return null;const L=q&&q.current&&q.current.getBoundingClientRect(),M=L?{getBoundingClientRect:()=>L}:null;return l.a.createElement(l.a.Fragment,null,E.visualization.type&&E.visualization.type!==c.n?l.a.createElement(m,b({visualization:E.visualization,responses:E.responses,extraOptions:E.extraOptions,legendSets:E.legendSets},v)):l.a.createElement(y,b({visualization:E.visualization,responses:E.responses,legendSets:E.legendSets,onToggleContextualMenu:h?(e,a)=>{V(e),k(a)}:void 0},v)),L&&Object(n.createPortal)(l.a.createElement("div",{onClick:R,style:x.backdrop},l.a.createElement(u.L,{reference:M,placement:"right"},l.a.createElement(g,{config:z,ouLevels:S,onClick:e=>{R(),h(e)}}))),document.body))};z.defaultProps={filters:{},forDashboard:!1,onError:Function.prototype,onLoadingComplete:Function.prototype,onResponsesReceived:Function.prototype,visualization:{},userSettings:{}},z.propTypes={visualization:i.a.object.isRequired,filters:i.a.object,forDashboard:i.a.bool,userSettings:i.a.object,onDrill:i.a.func,onError:i.a.func,onLoadingComplete:i.a.func,onResponsesReceived:i.a.func},a.default=z}}]);
//# sourceMappingURL=140.decdcf85.chunk.js.map